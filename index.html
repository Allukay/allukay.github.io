<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlindBox Tracker</title>

    <!-- Police -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">

    <!-- CSS externe -->
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <h1>BLINDBOX TRACKER</h1>

    <div class="menu-container" id="user-selection">
        <select id="user-select" onchange="selectUser()">
            <option value="" disabled selected>CHOISIR VOTRE PROFIL</option>
            <option value="celia">CELIA</option>
            <option value="emeline">EMELINE</option>
            <option value="ewen">EWEN</option>
            <option value="nathan">NATHAN</option>
        </select>
    </div>

    <div class="selection-container">
        <div class="menu-container" id="collection-selection" style="display: none;">
            <select id="collection-select" onchange="updateCards()">
                <option value="" disabled selected>CHOISIR UNE COLLECTION</option>
            </select>
        </div>

        <div class="menu-container" id="filter-container" style="display: none;">
            <select id="filter-select" onchange="updateCards()">
                <option value="all">TOUS LES ITEMS</option>
                <option value="owned">POSSÉDÉS</option>
                <option value="not-owned">NON POSSÉDÉS</option>
                <option value="favorites">FAVORIS</option>
            </select>
        </div>

        <!-- Barre de progression -->
        <div class="progress-container" id="progress-container" style="display: none;">
            <div class="progress-bar" id="progress-bar"></div>
            <span id="progress-text">0%</span>
        </div>
    </div>

    <div class="total-container" id="total-container" style="display: none;">
        <span>MONTANT GLOBAL : </span>
        <span id="total-amount">0</span>
    </div>

    <div class="card-container" id="card-list"></div>

    <div class="footer">©N.V</div>

    <script>
        const userNames = {
            "nathan": ["The Power Puff X Cry Baby"],
            "emeline": ["Nommi - Loveliness never ends"],
            "ewen": ["Lilios City Wild Boy"]
        };

        const collectionPrices = {
            "The Power Puff X Cry Baby": 15,
            'Nommi - Loveliness never ends': 25,
            "Lilios City Wild Boy": 15
        };

        const collectionBoxes = {
            "The Power Puff X Cry Baby": "Images/pop-mart-crybaby-powerpuff-girls_box.jpg",
            "Nommi - Loveliness never ends": "Images/nommibox.webp",
            "Lilios City Wild Boy": "Images/liliosbox.webp"
        };

        const collectionData = {
            "The Power Puff X Cry Baby": [
                { id: "Fig1", nom: "Bubbles", image: "Images/pop-mart-crybaby-powerpuff-girls_1.jpg" },
                { id: "Fig2", nom: "Blossom", image: "Images/pop-mart-crybaby-powerpuff-girls_2.jpg" },
                { id: "Fig3", nom: "Buttercup", image: "Images/pop-mart-crybaby-powerpuff-girls_3.jpg" },
                { id: "Fig4", nom: "Mojo Jojo", image: "Images/pop-mart-crybaby-powerpuff-girls_4.jpg" },
                { id: "Fig5", nom: "Bunny Bubbles", image: "Images/pop-mart-crybaby-powerpuff-girls_5.jpg" },
                { id: "Fig6", nom: "Bunny Blossom", image: "Images/pop-mart-crybaby-powerpuff-girls_6.jpg" },
                { id: "Fig7", nom: "Bunny Buttercup", image: "Images/pop-mart-crybaby-powerpuff-girls_7.jpg" },
                { id: "Fig8", nom: "The Professor", image: "Images/pop-mart-crybaby-powerpuff-girls_8.jpg" },
                { id: "Fig9", nom: "The Mayor", image: "Images/pop-mart-crybaby-powerpuff-girls_9.jpg" },
                { id: "Fig10", nom: "Bedtime Bubbles", image: "Images/pop-mart-crybaby-powerpuff-girls_10.jpg" },
                { id: "Fig11", nom: "Bedtime Blossom", image: "Images/pop-mart-crybaby-powerpuff-girls_11.jpg" },
                { id: "Fig12", nom: "Bedtime Buttercup", image: "Images/pop-mart-crybaby-powerpuff-girls_12.jpg" }, 
                { id: "Fig13", nom: "Secret Character", image: "Images/pop-mart-crybaby-powerpuff-girls_secret.jpg" }
            ],
            "Nommi - Loveliness never ends": [
                { id: "Fig1", nom: "TUTU", image: "Images/nommi1.jpg" },
                { id: "Fig2", nom: "BINBIN", image: "Images/nommi2.jpg" },
                { id: "Fig3", nom: "JUJU", image: "Images/nommi3.jpg" },
                { id: "Fig4", nom: "QUQI", image: "Images/nommi4.jpg" },
                { id: "Fig5", nom: "NENE", image: "Images/nommi5.jpg" },
                { id: "Fig6", nom: "MIMI", image: "Images/nommi6.jpg" },
                { id: "Fig7", nom: "XIXI", image: "Images/nommisecret.jpg" },
            ],
            "Lilios City Wild Boy": [
                { id: "Fig1", nom: "Autumn Whisper", image: "Images/lilios6.jpg" },
                { id: "Fig2", nom: "Summer Postman", image: "Images/lilios1.jpg" },
                { id: "Fig3", nom: "My Spacship", image: "Images/lilios5.jpg" },
                { id: "Fig4", nom: "Channel Aqaurium", image: "Images/lilios9.jpg" },
                { id: "Fig5", nom: "Winter Blossom", image: "Images/lilios7.jpg" },
                { id: "Fig6", nom: "Enchanter", image: "Images/lilios3.jpg" },
                { id: "Fig7", nom: "Not a King", image: "Images/lilios8.jpg" },
                { id: "Fig8", nom: "Spring Elf", image: "Images/lilios4.jpg" },
                { id: "Fig9", nom: "Hug me, Wildness", image: "Images/liliossecret.jpg" },
            ]
        };

        function selectUser() {
            const user = document.getElementById("user-select").value;
            localStorage.setItem("selectedUser", user);
            resetCollectionSelection();
            loadCollectionOptions(user);
        }

        function loadCollectionOptions(user) {
            const selectCollection = document.getElementById("collection-select");
            selectCollection.innerHTML = "";
            const defaultOption = document.createElement("option");
            defaultOption.value = "";
            defaultOption.disabled = true;
            defaultOption.selected = true;
            defaultOption.textContent = "Choisir une Collection";
            selectCollection.appendChild(defaultOption);

            if (userNames[user]) {
                userNames[user].forEach(collection => {
                    const option = document.createElement("option");
                    option.value = collection;
                    option.textContent = collection.charAt(0).toUpperCase() + collection.slice(1);
                    selectCollection.appendChild(option);
                });

                document.getElementById("collection-selection").style.display = "block";
            } else {
                document.getElementById("collection-selection").style.display = "none";
            }
        }

        function resetCollectionSelection() {
            document.getElementById("collection-select").selectedIndex = 0;
            document.getElementById("card-list").innerHTML = "";
            document.getElementById("filter-container").style.display = "none";
            document.getElementById("progress-container").style.display = "none";
        }

        function getCurrentUser() {
            return localStorage.getItem("selectedUser");
        }

        function saveSelection(id) {
            const checkbox = document.getElementById(id);
            const countInput = document.getElementById(`${id}-count`);

            if (checkbox.checked) {
                countInput.value = 1;  
            } else {
                countInput.value = 0;  
            }

            localStorage.setItem(id, checkbox.checked);
            localStorage.setItem(`${id}-count`, countInput.value);
            updateCards();
        }

        const cardVisualization = document.createElement("div");
        cardVisualization.id = "card-visualization";
        cardVisualization.innerHTML = `<img src="" alt="" id="visualization-img">`;
        document.body.appendChild(cardVisualization);

        function openCard(imageUrl) {
            const img = document.getElementById("visualization-img");
            img.src = imageUrl;
            cardVisualization.style.display = "flex";
        }

        function closeCard() {
            cardVisualization.style.display = "none";
        }

        cardVisualization.addEventListener("click", function(event) {
            if (event.target.id === "visualization-img") return;
            closeCard();
        });

        function updateCards() {
            const collection = document.getElementById("collection-select").value;
            const filter = document.getElementById("filter-select").value;
            const container = document.getElementById("card-list");
            container.innerHTML = "";

            if (collectionData[collection]) {
                document.getElementById("filter-container").style.display = "block";

                const boxCard = document.createElement("div");
                boxCard.className = "card";
                boxCard.innerHTML = `
                    <img src="${collectionBoxes[collection]}" alt="${collection}" onclick="openCard('${collectionBoxes[collection]}')">
                    <p>${collection}</p>
                `;
                container.appendChild(boxCard);

                collectionData[collection].forEach(figurine => {
                    const cardId = `${getCurrentUser()}-${figurine.id}`;
                    const owned = localStorage.getItem(cardId) === "true";
                    const favoriteId = `${getCurrentUser()}-${figurine.id}-fav`;
                    const favorite = localStorage.getItem(favoriteId) === "true";

                    if (filter === "owned" && !owned) return;
                    if (filter === "not-owned" && owned) return;
                    if (filter === "favorites" && !favorite) return;

                    const card = document.createElement("div");
                    card.className = "card";
                    card.innerHTML = `
                        <img src="${figurine.image}" alt="${figurine.nom}" onclick="openCard('${figurine.image}')">
                        <p>${figurine.nom}</p>

                        <input type="checkbox" id="${cardId}" onclick="saveSelection('${cardId}')" ${owned ? "checked" : ""}>
                        <label for="${cardId}">Possédée</label>

                        <input type="number" id="${cardId}-count" min="0" value="${localStorage.getItem(cardId + '-count') || 0}" 
                            onchange="updateCount('${cardId}')">
                        <label for="${cardId}-count"></label>

                        <span id="${favoriteId}" class="favorite-star" onclick="toggleFavorite('${favoriteId}')">
                            ${favorite ? "★" : "☆"}
                        </span>
                        <label for="${cardId}">Favori</label>
                    `;
                    container.appendChild(card);
                });

                updateProgress();
            }
        }

        function updateCount(cardId) {
            const count = document.getElementById(`${cardId}-count`).value;
            localStorage.setItem(`${cardId}-count`, count);
            updateProgress();
        }

        function toggleFavorite(favoriteId) {
            const current = localStorage.getItem(favoriteId) === "true";
            localStorage.setItem(favoriteId, !current);
            updateCards();
        }

        function updateProgress() {
            const collection = document.getElementById("collection-select").value;
            if (!collectionData[collection]) return;

            let total = collectionData[collection].length;
            let ownedCount = 0;
            let globalAmount = 0;

            const price = collectionPrices[collection] || 0;

            collectionData[collection].forEach(figurine => {
                const cardId = `${getCurrentUser()}-${figurine.id}`;
                const owned = localStorage.getItem(cardId) === "true";
                const count = parseInt(localStorage.getItem(cardId + '-count')) || 0;

                if (owned) {
                    ownedCount++;
                    globalAmount += count * price;
                }
            });

            const percent = Math.round((ownedCount / total) * 100);
            document.getElementById("progress-bar").style.width = `${percent}%`;
            document.getElementById("progress-text").textContent = `${percent}%`;

            document.getElementById("progress-container").style.display = "block";
            document.getElementById("total-amount").textContent = `${globalAmount} €`;
            document.getElementById("total-container").style.display = "block";
        }
    </script>

</body>
</html>
